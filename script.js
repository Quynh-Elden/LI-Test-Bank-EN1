// --- GÃœVENLÄ°K AYARLARI ---
const GLOBAL_SITE_PASS = "Admin123"; 

const authorizedUsers = {
    "442277": { name: "Queen Targaryen",   pass: "Queen1661" },
    "371687": { name: "Habib Targaryen",   pass: "Habib123" },
    "200328": { name: "Kayy Sarsilmaz",    pass: "Kayy123" },
    "286841": { name: "Courts Marelli",    pass: "Courts123" },
    "941":    { name: "Sully Ra'Nell",     pass: "Sully123" },
    "1001":   { name: "Test User",         pass: "1234" }
};

let currentQuestions = [];
let currentUserInfo = ""; 
let currentCategoryName = ""; 
let selectedIndices = []; // SeÃ§ilen sorularÄ±n numaralarÄ±nÄ± tutacaÄŸÄ±z

function checkLogin() {
    const siteInput = document.getElementById('sitePassInput').value.trim();
    const idInput = document.getElementById('userIdInput').value.trim();
    const passInput = document.getElementById('userPassInput').value.trim();
    const errorMsg = document.getElementById('error-msg');
    const welcomeMsg = document.getElementById('welcome-msg');
    const loginCard = document.querySelector('#login-screen .card'); 
    
    function triggerError(msg) {
        errorMsg.innerText = msg;
        errorMsg.style.display = 'block';
        loginCard.classList.add('shake');
        setTimeout(() => loginCard.classList.remove('shake'), 500);
    }

    if (siteInput !== GLOBAL_SITE_PASS) { triggerError("Global Site Access Code is wrong!"); return; }
    if (!authorizedUsers[idInput]) { triggerError("User ID not found in database!"); return; }
    if (authorizedUsers[idInput].pass !== passInput) { triggerError("Wrong personal password!"); return; }

    const userName = authorizedUsers[idInput].name;
    currentUserInfo = `${userName} (ID: ${idInput})`;
    
    errorMsg.style.display = 'none';
    welcomeMsg.innerText = `Access Granted. Welcome, ${userName}!`;
    welcomeMsg.style.display = 'block';
    setTimeout(() => {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('user-display').innerText = `Logged in as: ${currentUserInfo}`;
    }, 1000);
}

function logout() { location.reload(); }
function togglePassword(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }
document.addEventListener("keypress", function(e) { if(e.key==="Enter" && document.getElementById('login-screen').style.display!=='none') checkLogin(); });

// --- SINAV SÄ°STEMÄ° ---

function generateExam(categoryName) {
    currentCategoryName = categoryName;
    const fileName = `questions-${categoryName.toLowerCase()}.json`;

    fetch(fileName)
        .then(res => res.json())
        .then(data => {
            // Ã–nemli: SorularÄ±n orjinal indexlerini bulmak iÃ§in shuffle mantÄ±ÄŸÄ±nÄ± deÄŸiÅŸtiriyoruz
            const indices = Array.from({length: data.length}, (_, i) => i);
            
            // Indexleri karÄ±ÅŸtÄ±r
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            
            // Ä°lk 7 indexi al
            selectedIndices = indices.slice(0, 7);
            
            // Bu indexlere gÃ¶re sorularÄ± seÃ§
            const selectedQuestions = selectedIndices.map(i => data[i]);
            
            displayExam(selectedQuestions);
            
            // Link oluÅŸtur butonunu gÃ¶ster (EÄŸer varsa)
            // Butonun HTML'ini dinamik ekleyebiliriz
            showCandidateButton();
        })
        .catch(err => console.error(err));
}

function displayExam(questions) {
    const qBox = document.getElementById('questions-box');
    const aBox = document.getElementById('answers-box');
    document.getElementById('questions-section').style.display = 'block';
    document.getElementById('answers-section').style.display = 'none';

    let qText = "", aText = "";
    questions.forEach((item, index) => {
        qText += `${index + 1}) ${item.q}\n`;
        aText += `${index + 1}) ${item.a}\n`;
    });

    qBox.textContent = qText;
    aBox.textContent = aText;
}

function showAnswers() {
    document.getElementById('answers-section').style.display = 'block';
    document.getElementById('answers-section').scrollIntoView({ behavior: 'smooth' });
}

function copyToClipboard(id) {
    const content = document.getElementById(id).innerText;
    const now = new Date().toLocaleString('en-GB');
    let final = id === 'questions-box' ? `ðŸ›‘ EXAM LOG ðŸ›‘\nGenerated By: ${currentUserInfo} (${currentCategoryName})\nDate: ${now}\n------------------\n\n${content}` : content;
    navigator.clipboard.writeText(final).then(() => alert("Copied!"));
}

function downloadPDF() {
    const content = document.getElementById('questions-box').innerText;
    const pdfContent = `LIFEINVADER EXAM\nGen By: ${currentUserInfo}\nCat: ${currentCategoryName}\n\n${content}`;
    var element = document.createElement('div');
    element.innerText = pdfContent;
    html2pdf().from(element).save();
}

// --- YENÄ°: ADAY LÄ°NKÄ° OLUÅžTURUCU ---
function showCandidateButton() {
    // SorularÄ±n olduÄŸu kutunun hemen Ã¼stÃ¼ne buton ekleyelim
    const qSection = document.getElementById('questions-section');
    
    // EÄŸer buton zaten varsa tekrar ekleme
    if(document.getElementById('btn-candidate-link')) return;

    const btn = document.createElement('button');
    btn.id = 'btn-candidate-link';
    btn.className = 'btn btn-warning w-100 mb-2 fw-bold';
    btn.innerText = 'ðŸ”— Generate Candidate Link (15 Mins)';
    btn.onclick = generateCandidateLink;
    
    // Butonu "Copy Questions" butonunun Ã¼stÃ¼ne ekle
    const copyBtn = qSection.querySelector('button[onclick^="copyToClipboard"]');
    qSection.insertBefore(btn, copyBtn);
}

function generateCandidateLink() {
    // 1. Veriyi hazÄ±rla: Kategori + SeÃ§ilen Soru NumaralarÄ± + Åžu anki Zaman
    const payload = {
        cat: currentCategoryName.toLowerCase(),
        indices: selectedIndices,
        time: new Date().getTime() // Linkin oluÅŸturulduÄŸu zaman
    };

    // 2. Veriyi Åžifrele (Base64)
    const jsonString = JSON.stringify(payload);
    const token = btoa(jsonString);

    // 3. Linki oluÅŸtur
    // Mevcut URL'nin sonuna exam.html ekle
    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
    const link = `${baseUrl}/exam.html?token=${token}`;

    // 4. Kopyala
    navigator.clipboard.writeText(link).then(() => {
        alert("âœ… CANDIDATE LINK COPIED!\n\nSend this link to the candidate.\nWARNING: This link will expire in 30 minutes.");
    });
}
